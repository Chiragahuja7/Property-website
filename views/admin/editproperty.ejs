<style>
  .image-preview {
  position: relative;
  display: inline-block;
}

  .image-preview .btn-danger {
    opacity: 0;
    transition: opacity 0.2s ease-in-out;
    pointer-events: none;
    z-index: 2;
    padding: 2px 6px;
    font-size: 14px;
  }

  .image-preview:hover .btn-danger {
    opacity: 1;
    pointer-events: auto;
  }

</style>

<div class="page-title-wrapper d-lg-flex flex-column gap-3 p-3">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb mb-0 bg-transparent p-0">
      <li class="breadcrumb-item"><a href="/admin">Dashboard</a></li>
      <li class="breadcrumb-item"><a href="/properties">Properties</a></li>
      <li class="breadcrumb-item active" aria-current="page">Edit Property</li>
    </ol>
  </nav>
  <h1 class="page-title">Edit Property</h1>
</div>
<br><br>
<div class="full-row pt-0">
  <div class="container">
    <div class="row g-5">
      <div class="col-lg-12">
        <div class="contact-form">
          <form method="POST" class="editproperty" action="/editproperty/<%= property._id %>" enctype="multipart/form-data">
  <div class="row g-3">

    <div class="col-md-12">
      <label class="form-label">Name of Property</label>
      <input type="text" class="form-control" name="propertyName" 
             value="<%= property.propertyName %>" required>
    </div>

    <div class="col-md-12">
      <label class="form-label">Builder Name</label>
      <input type="text" class="form-control" name="builderName" 
             value="<%= property.builderName %>" required>
    </div>

    <div class="col-md-12">
      <label class="form-label">Description</label>
      <textarea id="description" name="description" class="form-control" rows="3" required><%= property.description %></textarea>
    </div>

    <div class="col-md-6">
      <label class="form-label">Property Type</label>
      <select class="form-select text-dark" name="propertyType" required>
      <% if (mydata && mydata.default.PROPERTY_TYPE) { %>
      <% mydata.default. PROPERTY_TYPE.forEach(function(type) { %>
        <option class="text-dark" value="<%= type %>" <%= property.propertyType == type ? "selected" : "" %>>
          <%= type %>
        </option>
         <% }) %>
         <% } %>
    </select>
    </div>

    <div class="col-md-6">
      <label class="form-label">Property Status</label>
      <select class="form-select text-dark" name="propertyStatus" required>
      <% if (mydata && mydata.default.PROPERTY_STATUS) { %>
      <% mydata.default. PROPERTY_STATUS.forEach(function(status) { %>
        <option class="text-dark" value="<%= status %>" <%= property.propertyStatus == status ? "selected" : "" %>>
          <%= status %>
        </option>
         <% }) %>
         <% } %>
    </select>
    </div>

    <div class="col-md-6">
  <label class="form-label">Location</label>
  <select class="form-select text-dark" name="location" required>
    <option class="text-dark" value="">-- Select Location --</option>
    <% mylocation.forEach(loc => { %>
    <option class="text-dark" value="<%= loc.location %>" <%= property.location == loc.location ? "selected" : "" %>>
    <%= loc.location %>
    </option>
    <% }) %>
  </select>
    </div>


    <div class="col-md-6">
      <label class="form-label">Price Per Sq. Feet</label>
      <input type="number" class="form-control" name="pricePerSquareFeet" 
             value="<%= property.pricePerSquareFeet %>" required>
    </div>

    <div class="col-md-6">
      <label class="form-label">Area (From Sq. Ft.)</label>
      <input type="number" class="form-control" name="areaSquareFeetFrom" 
             value="<%= property.areaSquareFeetFrom %>" required>
    </div>
    <div class="col-md-6">
      <label class="form-label">Area (To Sq. Ft.)</label>
      <input type="number" class="form-control" name="areaSquareFeetTo" 
             value="<%= property.areaSquareFeetTo %>" required>
    </div>

    <div class="col-md-6">
      <label class="form-label">Price From (Words)</label>
      <input type="text" class="form-control" name="priceFromInWords" 
             value="<%= property.priceFromInWords %>" required>
    </div>
    <div class="col-md-6">
      <label class="form-label">Price To (Words)</label>
      <input type="text" class="form-control" name="priceToInWords" 
             value="<%= property.priceToInWords %>" required>
    </div>
    <div class="col-md-6">
      <label class="form-label">Price From (Number)</label>
      <input type="number" class="form-control" name="priceFromInNumber" 
             value="<%= property.priceFromInNumber %>" required>
    </div>
    <div class="col-md-6">
      <label class="form-label">Price To (Number)</label>
      <input type="number" class="form-control" name="priceToInNumber" 
             value="<%= property.priceToInNumber %>" required>
    </div>

    <div class="col-md-12">
      <label class="form-label">Address</label>
      <textarea class="form-control" name="address" rows="2" required><%= property.address %></textarea>
    </div>

    <div class="col-md-6">
      <label class="form-label">Video URL</label>
      <input type="url" class="form-control" name="videoUrl" 
             value="<%= property.videoUrl %>" required>
    </div>

    <div class="col-md-6">
    <label class="form-label">Year Of Construction</label>
    <select class="form-select text-dark" name="yearsOfConstruction" required>
      <% if (mydata && mydata.default.YEARS_OF_CONSTRUCTION) { %>
      <% mydata.default.YEARS_OF_CONSTRUCTION.forEach(function(year) { %>
        <option class="text-dark" value="<%= year %>" <%= property.yearsOfConstruction == year ? "selected" : "" %>>
          <%= year %>
        </option>
         <% }) %>
         <% } %>
    </select>
    </div>

    <div class="col-md-12">
      <label class="form-label">Listing Status</label>
      <select class="form-select text-dark" name="listingStatus" required>
      <% if (mydata && mydata.default.LISTING_STATUS) { %>
      <% mydata.default.LISTING_STATUS.forEach(function(status) { %>
        <option class="text-dark" value="<%= status %>" <%= property.listingStatus == status ? "selected" : "" %>>
          <%= status %>
        </option>
         <% }) %>
         <% } %>
    </select>
    </div>
  </div>
<hr>
<br>
<div class="row g-3 mt-3">
    <h1 class="page-title">Property Images</h1>
    <div class="col-lg-12">
        <label>Main Image</label>
        <input type="file" class="form-control" name="mainImage" accept="image/*">
    </div>
    <% if (property.mainImage) { %>
        <div class="col-lg-12 uploaded-images mt-3">
            <label>Already Uploaded Main Image:</label>
            <div class="d-flex flex-wrap gap-2">
                        <div class="image-preview position-relative">
                            <img src="<%= property.mainImage %>" style="width:130px;height:100px;object-fit:cover;">
                        </div>
            </div>
        </div>
    <% } %>
    <div class="col-lg-12">
        <label>Upload New Images</label>
        <input type="file" class="form-control" name="upload" accept="image/*" multiple>
    </div>
    <% if (property.upload && property.upload.length) { %>
        <div class="col-lg-12 uploaded-images mt-3">
            <label>Already Uploaded Images:</label>
            <div class="d-flex flex-wrap gap-2">
                <% property.upload.forEach(function(img, index) { %>
                    <% if (img) { %>
            <div class="image-preview position-relative">
              <img src="<%= img %>" style="width:130px;height:100px;object-fit:cover;">
              <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 delete-image-btn" data-index="<%= index %>">×</button>
            </div>
                    <% } %>
                <% }) %>
            </div>
        </div>
    <% } %>
</div>

<hr>
<br>
  <div class="row g-3 mt-3">
    <h1 class="page-title">Edit Property Amenities</h1>

    <div class="col-lg-12">
      <label>Select Amenities</label>
      <br><br>
      <div class="form-check">
        <% myamenities.forEach(function(amenity) { %>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="amenities" value="<%= amenity.amenities %>"
             <% if (property.amenities && property.amenities.includes(amenity.amenities)) { %> checked <% } %>>
            <label class="form-check-label"><%= amenity.amenities %></label>
          </div>
        <% }) %>
      </div>
    </div>
  </div>
<hr>
<br>
<div class="row g-3 mt-3">
<h1 class="page-title">Additional Info.</h1>
<div class="col-lg-12">
<h7>Select Apartement type</h7>
<br><br>
<div class="form-check">
  <input class="form-check-input" type="checkbox" name="additionalInfo" value="1bhk"
    <% if (property.additionalInfo && property.additionalInfo.includes("1bhk")) { %> checked <% } %>>
  <label class="form-check-label">1 bhk</label>
</div>
<div class="form-check">
  <input class="form-check-input" type="checkbox" name="additionalInfo" value="2bhk"
    <% if (property.additionalInfo && property.additionalInfo.includes("2bhk")) { %> checked <% } %>>
  <label class="form-check-label">2 bhk</label>
</div>
<div class="form-check">
  <input class="form-check-input" type="checkbox" name="additionalInfo" value="3bhk"
    <% if (property.additionalInfo && property.additionalInfo.includes("3bhk")) { %> checked <% } %>>
  <label class="form-check-label">3 bhk</label>
</div>
<div class="form-check">
  <input class="form-check-input" type="checkbox" name="additionalInfo" value="4bhk"
    <% if (property.additionalInfo && property.additionalInfo.includes("4bhk")) { %> checked <% } %>>
  <label class="form-check-label">4 bhk</label>
</div>
<div class="form-check">
  <input class="form-check-input" type="checkbox" name="additionalInfo" value="5bhk"
    <% if (property.additionalInfo && property.additionalInfo.includes("5bhk")) { %> checked <% } %>>
  <label class="form-check-label">5 bhk</label>
</div>
</div>
</div>

<hr>
<br>
<h1 class="page-title">Builder Description</h1>
    <div class="col-md-12">
      <label class="form-label">Description</label>
      <textarea id="builderdescription" class="form-control" name="builderDescription" rows="3" required><%= property.builderDescription %></textarea>
    </div>
<hr>
<br>
<h1 class="page-title pb-3">Nearby Places</h1>
<div class="row g-3" id="nearbyPlacesWrapper">
  <% if (property.nearbyPlaces && property.nearbyPlaces.length > 0) { %>
    <% property.nearbyPlaces.forEach(function(place, index) { %>
      <div class="col-md-6 d-flex gap-2">
        <input class="form-control" name="nearbyPlaces" value="<%= place %>">
        <input class="form-control" name="nearbyPlacesKm" value="<%= property.nearbyPlacesKm && property.nearbyPlacesKm[index] ? property.nearbyPlacesKm[index] : '' %>">
        <button type="button" class="btn removePlace">❌</button>
      </div>
    <% }) %>
  <% } else { %>

    <div class="col-md-6 d-flex gap-2">
      <input class="form-control" name="nearbyPlaces" value="">
      <input class="form-control" name="nearbyPlacesKm" value="">
      <button type="button" class="btn removePlace">❌</button>
    </div>
  <% } %>
</div>

<div class="mt-3">
  <button type="button" class="btn btn-primary" id="addPlace">+ Add More</button>
</div>

<br><br>
<div class="col-lg-12">
    <button type="submit" class="btn btn-primary">Save</button>
</div>
</form>
<script>
document.querySelectorAll(".editproperty").forEach(form => {
  form.addEventListener("submit", async function (e) {
    e.preventDefault();

    const formData = new FormData(this);

    try {
      const res = await fetch(this.action, {
        method: "POST",
        body: formData
      });
      const data = await res.json();
      if (data.success) {
        Toastify({
                    text: "Property Updated successfully ✅",
                    duration: 3000,
                    gravity: "top",
                    position: "center",
                    backgroundColor: "#4CAF50",
                    close: true,
                  }).showToast();

                  setTimeout(() => {
                    window.location.href = "/properties";
                  }, 1500);
      } else {
         Toastify({
                    text: "Something went wrong ❌",
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "#FF5252",
                    close: true,
                  }).showToast();
                }
    } catch (err) {
      Toastify({
                  text: "Server error! ⚠️",
                  duration: 3000,
                  gravity: "top",
                  position: "right",
                  backgroundColor: "#FFA000",
                  close: true,
                }).showToast();
    }
  });
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const wrapper = document.getElementById("nearbyPlacesWrapper");
  const addBtn = document.getElementById("addPlace");
    addBtn.addEventListener("click", function () {
    const div = document.createElement("div");
    div.className = "col-md-6 d-flex gap-2";
    div.innerHTML = `
      <input class="form-control" name="nearbyPlaces" value="">
      <input class="form-control" name="nearbyPlacesKm" value="">
      <button type="button" class="btn btn-danger removePlace">❌</button>
    `;
    wrapper.appendChild(div);
  });
  wrapper.addEventListener("click", function (e) {
    if (e.target.classList.contains("removePlace")) {
      e.target.parentElement.remove();
    }
  });
});
</script>
<script>
document.addEventListener('click', function (e) {
  if (e.target && e.target.classList.contains('delete-image-btn')) {
    const index = e.target.getAttribute('data-index');
    const propertyId = '<%= property._id %>';
    if (!confirm('Are you sure you want to delete this image?')) return;

    fetch(`/delete-image/${propertyId}?index=${index}`, {
      method: 'POST',
      headers: { 'Accept': 'application/json' }
    }).then(res => {
      if (res.ok) {
        window.location.reload();
      } else {
        alert('Failed to delete image');
      }
    }).catch(err => {
      console.error(err);
      alert('Error deleting image');
    });
  }
});
</script>
        </div>
      </div>
    </div>
  </div>
</div>
