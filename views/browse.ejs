<style>
.property-img {
  width: 100%;
  height: 180px;
  object-fit:cover;
}
</style>

<div class="full-row p-3 bg-white">
    <div class="full-row inner-page-banner pb-0 pt-2">
        <div class="container">
            <div class="row">
                <div class="col">
                    <div class="page-title-wrapper d-lg-flex flex-column gap-3">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb mb-0 bg-transparent p-0">
                                <li class="breadcrumb-item"><a href="/">Home</a></li>
                                <li class="breadcrumb-item"><a href="/browse">Browse</a></li>
                            </ol>
                        </nav>
                        <h1 class="page-title">Browse Properties</h1>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col">
            <div class="listing-filter-bar">
                <div class="result-wrapper pt-1">
                    <span class="ordering-pages ps-2 ms-1">Showing <%= myproperties.filter(p => p.listingStatus === "published").length %> results
                    </span>
                </div>
                <div class="text-end mb-3">
                   <% if (myproperties.filter(p => p.listingStatus === "published").length > 0) { %>
                   <button id="toggleCompare" class="btn btn-primary me-2">Compare</button>
                   <% } %>
             <button id="goToCompare" class="btn btn-success d-none">Go to Compare</button>
             </div>
            </div>
        </div>
    </div>
 <div class="container">
  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="property-list">
    <% if (myproperties && myproperties.length > 0) { %>
      <% let publishedProperties = myproperties.filter(p => p.listingStatus === "published"); %>
      <% if (publishedProperties.length > 0) { %>
        <% publishedProperties.forEach(function(property) { %>
          <div class="col">
            <div class="card shadow h-100 property-item position-relative">
              <div class="property-grid-2 property-block h-100">
                <div class="entry-wrapper">
                  <div class="entry-thumbnail max-height-180px position-relative">
                    <div class="type position-absolute top-0 start-0 m-2">
                      <% if (property.propertyStatus === 'Sale') { %>
                        <span class="badge bg-danger">For Sale</span>
                      <% } else { %>
                        <span class="badge bg-success">For Rent</span>
                      <% } %>
                    </div>

                    <div class="post-date position-absolute bottom-0 start-0 m-2 text-white small">
                      <i class="fa-regular fa-calendar-days"></i>
                      <%= property.createdAt ? property.createdAt.toDateString() : '' %>
                    </div>

                    <a href="/property/<%= property._id %>" class="d-block">
                      <img src="<%= property.mainImage || '/assets/images/landing_bg.png' %>" 
                           alt="Property Image"
                           class="img-fluid w-100 rounded-top property-img" />
                    </a>

                    <div class="position-absolute top-0 end-0 m-2 d-none compare-checkbox" style="z-index: 10;">
                      <input type="checkbox" name="compare" class="compare-input form-check-input" value="<%= property._id %>">
                    </div>
                  </div>

                  <div class="entry-content-wrapper p-3">
                    <h6 class=" mb-1 bg-black d-inline-block px-2 py-1 rounded">
                      <a class="stretched-link text-decoration-none text-white" href="/property/<%= property._id %>">
                        <%= property.propertyType %>
                      </a>
                    </h6>
                    <h5 class="fw-bold">
                      <a href="/property/<%= property._id %>" class="text-dark text-decoration-none">
                        <%= property.propertyName %>
                      </a>
                    </h5>
                    <p class="text-muted small mb-2">
                      <i class="fas fa-map-marker-alt"></i> <%= property.location %>
                    </p>

                    <ul class="list-inline mb-2 small">
                      <li class="list-inline-item me-3"><i class="fa-solid fa-bed"></i> <%= property.additionalInfo %></li>
                      <li class="list-inline-item"><i class="fa-solid fa-vector-square"></i> <%= property.areaSquareFeetFrom %> Sqft</li>
                    </ul>

                    <div class="fw-bold text-success fs-6">
                      â‚¹<%= property.priceFromInNumber %>
                      <% if (property.status === 'For Rent') { %>
                        <small>/mo</small>
                      <% } else { %>
                        <small>/Fixed</small>
                      <% } %>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <% }) %>
      <% } else { %>
        <p class="text-center">No properties found.</p>
      <% } %>
    <% } else { %>
      <p class="text-center">No properties found.</p>
    <% } %>
  </div>
</div>

<%- include('./partials/browsePagination') %>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const toggleBtn = document.getElementById('toggleCompare');
  const goBtn = document.getElementById('goToCompare');
  const checkboxes = document.querySelectorAll('.compare-checkbox');
  const compareInputs = document.querySelectorAll('.compare-input');

  let compareMode = false;

  toggleBtn.addEventListener('click', function () {
    compareMode = !compareMode;

    checkboxes.forEach(cb => {
      cb.classList.toggle('d-none', !compareMode);
    });

    goBtn.classList.toggle('d-none', !compareMode);
    toggleBtn.textContent = compareMode ? 'Cancel Compare' : 'Enable Compare';
  });

  goBtn.addEventListener('click', function () {
    const selected = Array.from(compareInputs)
      .filter(input => input.checked)
      .map(input => input.value);

    if (selected.length < 2) {
      alert('Please select at least two properties to compare.');
      return;
    }
    fetch('/compare', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ properties: selected })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        window.location.href = '/compare';
      } else {
        alert('Error saving compare data');
      }
    })
    .catch(err => console.error(err));
  });
});
</script>
